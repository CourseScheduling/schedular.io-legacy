extends ../MainTemplate

block headContent
    style.

        #mainContent{
            height:100%;
            width:1000px;
            margin-left:-500px;
            position:absolute;
            top:0px;
            left:50%;
        }
            #centerContainer{
                position:absolute;
                top:50%;
                margin-top:-250px;
                width:800px;
                margin-left:100px;
            }
                #mainTitle{
                    font-size:50px;
                    font-family:Raleway;
                    font-weight:100;
                    text-align:center;
                }
                #courseInput{
                    width:600px;
                    position:relative;
                    margin-left:-300px;
                    left:50%;
                    padding:10px;
                    border:1px solid #DDD;
                    font-family:Open Sans;
                    outline:0;
                    font-weight:300;
                    font-size:13px;
                }
                #scheduleCreate{
                    padding:5px;
                    border:3px solid rgba(255,255,255,0.1);
                    color:#FFF;
                    font-size:12px;
                    font-family:Open Sans;
                    width:150px;
                    background:#3498db;
                    margin-top:50px;
                    font-weight:600;
                    border-radius:2px;
                    cursor:pointer;
                    position:relative;
                    left:50%;
                    margin-left:-75px;
                }
                .clearfix:after {
                   content: " "; /* Older browser do not support empty content */
                   visibility: hidden;
                   display: block;
                   height: 0;
                   clear: both;
                }
                a{
                    color:inherit;
                    outline:0;
                    text-decoration:none;
                }
                [contenteditable=true]:empty:after{
                  color:#888;
                  content: attr(placeholder);
                  display: block; /* For Firefox */
                }
                #instantDropDown{
                    width:100px;
                    border:1px solid #BBB;
                    display: none;
                    top:-1px;
                }
                    .instant-resultContainer{
                        padding:7px;
                        padding-left:10px;
                        cursor:pointer;
                    }
                        .instant-resultContainer:hover{
                            background-color:#89C4F4;
                        }
                        .instant-resultCourseName{
                            font-family:Raleway;
                            font-size:13px;
                            font-weight:600;
                        }
                        .instant-resultCourseCode{
                            font-family:Open Sans;
                            font-size:12px;
                            font-weight:300;
                            color:#666;
                            margin-left:10px;
                        }
                        .courseChoice-wrap{
                            list-style-type:none;
                            display:block;
                        }
                        .courseChoice{
                            padding:10px;
                            border-radius:30px;
                            border:1px solid #000;
                            font-family:Open Sans;
                            font-size:12px;
                            font-weight:300;
                            display:block;
                            float:left;
                            margin:3px;
                        }
                        .courseKill{
                            background:url(/images/kill.png) center center no-repeat;
                            height:16px;
                            width:16px;
                            float:left;
                            display:inline-block;
                            margin-right:5px;
                            cursor:pointer;
                        }
    title="Create Schedule"
block bodyContent
    section#mainContent
        #centerContainer
            p#mainTitle Your Courses
            div#courseInput(type="text",contenteditable="true",placeholder="Enter your courses, e.g. Academic Writing, ENGL105")
            div#instantDropDown
            br
            p(style="font-family:Open Sans;font-size:12px;font-weight:100;padding-left:100px;") Your Current Schedule Contains:
            ul#courseChoiceContainer(style="margin-left:100px;width:100%;float:left;")
            br
            button#scheduleCreate(type="submit") Create Schedule


    footer
    script.
        var courseInput =   {
            element:document.getElementById('courseInput'),
            pastValue:'',
            currentInstance:0,
            getValue:function(){
                return this.element.innerHTML.replace(/(<([^>]+)>)/ig,"").replace('&nbsp;','');
            },
            keypress:function(e){
                var currentValue    =   _CIthis.getValue();    
                if(currentValue==_CIthis.pastValue){
                    return;
                }
                _CIthis.pastValue  =   currentValue;
                _CIthis.currentInstance++;

                $.get({
                    url:'/s/get?courseInput='+currentValue,
                    done:function(e){
                        if(e.length==0){
                            dropDown.up();
                            return;
                        }

                        dropDown.load(e);
                        dropDown.drop();
                    }
                });
            },
            init:function(){
                 _CIthis   =   this;
                this.element.addEventListener('keyup',this.keypress);
            }
        }
        courseInput.init();

        var dropDown    =   {
            isDown:false,
            mainInput:courseInput,
            dropDown:document.getElementById('instantDropDown'),
            drop:function(){
                console.log(this.mainInput.getValue()=='')
                if(this.mainInput.getValue()!=''&&!this.isDown){
                    Velocity(this.dropDown,'slideDown',50);
                    this.isDown =   true;
                    return;
                }
                if(this.mainInput.getValue()==''&&this.isDown){
                    Velocity(this.dropDown,'slideUp',50);
                    this.isDown =   false;
                    return;
                }
            },
            up:function(){
                Velocity(this.dropDown,'slideUp',50);
                this.isDown =   false;
            },
            load:function(courses){
                var _this   =   this;
                    _this.dropDown.innerHTML='';
                courses.forEach(function(v,i,a){
                    _this.dropDown.innerHTML+=[
                        '<div class="instant-resultContainer" data-courseCode="',v.courseCode,'" onclick="chosenCourses.add(this)">',
                            '<strong class="instant-resultCourseName">',
                            v.courseName,
                            '</strong>',
                            '<span class="  instant-resultCourseCode">',
                            v.courseCode,
                            '<span>',
                        '</div>'
                    ].join('');

                });
            },
            getPos:function(el) {
                return {
                    x:el.offsetLeft,
                    y:el.offsetTop + el.offsetHeight,
                    width:el.offsetWidth
                };
            },
            flush:function(){
                this.dropDown.innerHTML='';
            },
            init:function(){
                this.isDown =   false;
                this.dropDown.style.position='relative';
                this.dropDown.style.width   =   parseInt(this.getPos(this.mainInput.element).width)-2+'px';
                this.dropDown.style.left   =   parseInt(this.getPos(this.mainInput.element).x)+'px';
            }
        }
        dropDown.init();

        var chosenCourses   =   {
            container:document.getElementById('courseChoiceContainer'),
            courseList:[],
            createButton:function(html){
                var li = document.createElement('li');
                var span    =   document.createElement('span');
                var img     =   document.createElement('div');

                img.className   =   'courseKill';
                img.setAttribute('onclick','chosenCourses.remove(this)');
                li.className='courseChoice-wrap';
                span.setAttribute('data-courseCode',html);
                span.className='courseChoice';
                span.appendChild(img);
                span.innerHTML+=html;
                li.appendChild(span);

                return li;
            },
            add:function(e){
                var courseCode  =   e.getAttribute('data-courseCode');
                var button  =   this.createButton(courseCode);
                var courseJSON  =   {};
                courseJSON.button   =   button;
                courseJSON.code =   courseCode;
                this.courseList.push(courseJSON);
                this.container.appendChild(button);
                dropDown.flush();
                dropDown.up();
                dropDown.mainInput.element.innerHTML='';
            },
            remove:function(e){
                chosenCourses.courseList    =   chosenCourses.courseList.filter(function(a){
                    return e.parentNode.getAttribute('data-courseCode')!==a.code
                });
                e.parentNode.parentNode.parentNode.removeChild(e.parentNode.parentNode);
            }
        };

        var submit  =   {
            button:document.getElementById('scheduleCreate'),
            submit:function(){
                if(chosenCourses.courseList.length==0)
                    return false;
                var courseList  =   [];
                chosenCourses.courseList=chosenCourses.courseList.map(function(e){
                    courseList.push([e.code.split(/(\d)/).shift(),e.code.split(/(\d)/).splice(1).join('')]);
                    return e;
                });
                document.location   =   '/s/show/?c='+JSON.stringify(courseList);
            },
            init:function(){
                this.button.addEventListener('click',this.submit)
            }
        }
        submit.init();
        document.location.hash='';