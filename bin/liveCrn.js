var Mem = require('memcached');
//var mem =   new memcached('schedular.luawsd.cfg.usw2.cache.amazonaws.com:11211');
var memServer=new Mem('127.0.0.1:11211');
//Variables for CRN and memcached
var CRN_UPDATE_KEY  =   "courseDataDate";
var CRN_PREFIX   =   "crn_";
//Okay, don't judge me..
var CRN_ARRAY    = [20160,10023,10024,10025,11545,10026,10027,10028,11255,11256,11257,11252,11258,11259,11260,20160,11261,11262,11263,11253,11264,11265,11266,11267,11268,11269,10029,10030,10031,10032,10033,10034,11505,10035,10036,10037,10038,20160,10039,10040,10041,10042,10043,10044,10045,10046,10047,10048,10049,10050,10051,10052,10053,10054,10055,10056,10057,10058,10059,20160,10060,10061,10062,10063,10064,10065,10066,10067,10068,10069,10070,10071,10072,10074,10075,10076,10077,10078,10080,10079,10081,10082,10083,10084,10085,10086,10087,20160,10088,10089,10090,10091,10092,10093,10094,10095,10096,10097,10098,10099,10100,10101,11552,10102,10103,10104,10105,10106,10107,20160,10108,10109,10110,10111,10112,10113,10114,10115,10116,10117,10118,10119,11517,10120,10121,10122,10123,11511,10124,10125,10126,10127,10128,10129,20160,10130,10131,10132,10133,10134,10135,10136,10137,10138,10139,10140,10141,10142,10143,10144,10145,10146,10147,10148,10149,10150,10151,10152,10153,20160,10154,10155,10156,10157,10158,10159,10160,10161,10162,10163,10164,10165,10166,10167,10168,10169,10170,10171,10172,10173,10174,10175,20160,10176,10177,10178,10179,10180,10181,10182,10183,10184,10185,10186,10187,10188,10189,10190,10191,10192,10193,10194,10195,20160,10196,10197,10198,10199,10200,10201,10202,10203,10204,10205,10206,10207,10208,10209,10210,10211,10212,10213,10214,10215,10216,10217,10218,10219,20160,10220,10221,10222,10223,10224,10225,10226,10227,10228,10229,10230,10231,10232,11466,10233,10234,10235,10236,10237,10238,10239,10240,10241,10242,20160,10243,10244,11524,10245,10246,10247,10248,10249,10250,11523,10251,10252,10253,10254,10255,10256,10257,10258,10259,10260,11525,10261,10262,20160,10265,10266,10267,10268,10269,10270,10271,10272,10273,10274,10275,10276,10277,10278,10279,10280,10281,10282,10283,10284,20160,10285,10286,10287,10288,10289,10290,10291,10292,10293,10294,10295,10296,10297,10298,10299,10300,10301,10302,20160,10303,10304,10305,10306,10307,10308,10309,10310,10311,10312,10313,10314,10315,10316,10317,10318,10319,11485,10320,10321,10322,11473,11474,20160,10323,10324,10325,10326,10327,10328,10329,10330,11507,11508,11509,11510,10331,10332,10333,11514,10334,10335,10336,10337,10338,10339,10340,10341,10342,10343,10344,20160,10345,10346,10347,10348,10349,10350,10351,10352,10353,10354,11548,10355,10356,10357,10358,10359,10360,10361,10362,10363,10364,10365,10366,11549,20160,10367,10368,10369,10370,10371,10372,10373,10374,10375,10376,10377,10378,10379,10380,10381,10382,10383,10384,11540,10385,10386,10387,10388,10389,10390,10391,20160,10392,10393,10394,10395,10396,10397,10398,10399,10400,10401,10402,10403,10404,11512,10405,10406,11513,10407,10408,10009,10020,10018,10010,20160,10019,10011,10012,10013,10014,10015,10016,10017,10409,10410,10411,10412,10413,10414,10415,10416,10417,10418,10419,10420,10421,10422,10423,10424,10425,10426,10427,10428,10429,10430,10431,20160,10432,10433,10434,10435,10436,10437,10438,10439,10440,10441,10442,10443,10444,10445,10446,10447,10448,10449,10450,10451,10452,10453,10454,10455,11527,10456,10457,10458,10459,20160,10460,10461,11471,10462,10463,10464,10465,10466,11529,10467,10470,10471,10472,10473,10474,10475,10476,10477,10478,10479,10480,10481,10482,10483,10484,20160,10485,10486,10487,10488,10489,10490,10491,10492,10493,10494,10495,10496,10497,10498,10499,10500,10501,10502,10503,10504,10505,10506,10507,10508,10509,10510,10511,20160,10512,10513,10514,10515,10516,10517,10518,10519,10520,10521,10522,10523,10524,10525,10526,11543,10527,10528,10529,11541,10530,10531,10532,10533,10534,10535,20160,10536,10537,10538,10539,10540,10541,10542,10543,10544,10545,11326,11327,11328,11329,11330,11331,11332,11333,11334,11335,11336,11337,11338,11339,10546,10547,10548,10549,10550,10551,10552,10553,10554,10555,20160,10556,10557,10558,10559,10560,10561,10562,10563,10564,10565,10566,10567,10569,10570,10571,10572,10573,10574,10575,10576,10577,10578,10579,10580,10581,10582,10583,10584,10568,10585,10586,10587,10588,10589,10590,10591,10592,10593,10594,10595,10596,10597,10598,10599,20160,10600,10601,10602,10603,10604,10605,10606,10607,10608,10609,10610,10611,11550,10612,10613,10614,10615,10616,10617,10618,10619,10620,10621,10622,10623,10624,10625,10626,11463,10627,10628,20160,10629,10630,10631,10632,10633,10634,10635,11503,11495,11489,11493,11497,11502,11496,11490,11499,11491,11494,11500,11528,11501,11492,11498,10636,10637,10638,10639,11464,10640,20160,10641,10642,10643,10644,10645,10646,10647,10648,10649,10650,10651,10652,10653,10654,10655,10656,10657,10658,10659,10660,10661,10662,10663,10664,10665,10666,10667,10668,10669,10670,10671,10672,10673,10674,10675,10676,10677,10678,10679,10680,10681,10682,11468,10683,10684,10685,20160,10686,10687,10688,10689,10690,10691,10692,10693,10694,10695,10696,11479,10697,10698,10699,10700,10701,10702,10703,10704,10705,10706,10707,10708,20160,10709,10710,10711,10712,10713,10714,10715,10716,10717,10718,10719,10720,10721,10722,20160,10723,10724,10725,10726,10727,10728,11547,10729,10730,11538,10731,10732,10733,11535,10734,10735,10736,11536,11537,11539,11534,10737,10738,10739,10740,10741,20160,10742,10743,10744,10745,10746,10747,10748,10749,10750,10751,10752,10753,10754,10755,10756,10757,10758,10759,10760,20160,10761,11469,10762,10763,10764,10765,10766,10767,10768,10769,10770,10771,10772,11482,11480,11483,11481,11279,11280,11281,11282,11283,11284,11272,11285,10773,10774,10775,20160,10776,10777,10778,10779,10780,10781,11484,10782,10783,10784,10785,10786,10787,11515,11516,11531,10788,10789,10790,10791,10792,10793,10794,10795,10796,10797,10798,10799,10800,10801,10802,10803,10804,11546,10805,20160,10806,10807,10808,10809,10810,10811,10812,10813,10814,10815,10816,10817,10818,10819,10820,10821,10822,10823,10824,10825,10826,10827,20160,10828,10829,10830,10831,10832,10833,10834,10835,10836,10837,10838,10839,10840,10841,10842,10843,10844,10845,10846,10847,10848,10849,20160,10850,10851,10852,10853,10854,10855,10856,10857,10858,10859,10860,10861,10862,10863,10864,10865,11486,11488,11506,11533,11487,10866,10867,10868,10869,10870,10871,10872,10873,10874,20160,10875,10876,10877,10878,10879,10880,20160,10881,10882,20160,10883,10884,20160,10885,10886,10887,10888,20160,10889,10890,11270,10891,10892,10893,10894,10895,10896,10897,10898,20160,10899,11504,10900,10901,10902,10903,10904,10905,10906,10909,10910,10911,10912,10913,10914,10915,10916,10917,10918,20160,10919,10920,10921,10922,10923,11475,11476,10924,10925,10926,10927,10928,10929,10930,10931,10932,10933,20160,10934,10935,10936,10937,10938,11286,11287,11288,11289,11290,11291,11292,11293,11294,11295,11296,11297,11310,11298,11299,11273,11274,11275,11276,11277,11278,11300,10939,10940,10941,10942,10943,10944,10945,10946,10947,10948,20160,10949,10950,10951,10952,10953,10954,10955,10956,10957,10958,10959,10960,10961,11521,11522,11467,10962,10963,10964,10965,10966,10967,10968,10969,10970,10971,10972,10973,10974,10975,10976,10977,20160,10978,10979,10980,10981,10982,10983,10984,10985,10986,10987,10988,10989,10990,10991,11301,11302,11303,11304,11305,11306,11307,11311,11312,11313,11314,11315,11308,11309,10992,10993,20160,10994,11551,10995,10996,10997,10998,10999,11000,11001,11002,11003,11004,11254,11005,11271,11006,11007,11465,11008,11009,11010,11011,11012,11013,11014,20160,11015,11016,11017,11018,11019,11020,11021,11022,11023,11024,11025,11026,11027,11028,11029,11030,11031,11032,11033,11034,11035,11036,11037,20160,11038,11039,11040,11041,11042,11043,11044,11045,11472,11046,11532,11047,11048,11049,11050,11051,11052,11053,11054,11055,11056,11057,20160,11058,11059,11060,11061,11062,11063,11064,11065,11066,11067,11520,11068,11069,11070,11071,11072,11073,11074,11075,11076,11077,11078,11079,11080,11081,11082,20160,11083,11084,11085,11086,11087,11088,11089,11090,11091,11092,11093,11094,11095,11096,11097,20160,11098,11099,11100,11101,11102,11103,11104,11105,11106,11107,11108,11109,11110,11111,11112,11113,11114,11115,11116,20160,11117,11118,11119,11120,11121,11122,11123,11124,11125,11129,11130,11131,11132,11133,11134,11135,11136,11137,11138,11139,11140,11141,11142,11143,11144,11145,11146,11147,11148,11149,20160,11150,11151,11152,11153,11154,11155,11156,11157,11158,11159,11160,11161,11162,11163,11164,11165,11166,11167,11168,11169,11170,11171,11172,11173,11174,11175,11176,11177,11178,11179,20160,11180,11181,11182,11183,11184,11185,11186,11187,11188,11189,11190,11191,11192,11193,11194,11195,11196,11197,11198,11199,11200,11201,11202,11203,11204,11205,11206,11207,11208,11209,11210,11211,11212,11213,11214];

var app =   {
    timeOut:{},
    init:{},
    pushSockets:{}
};

app.init   =   function(){
    
    // Create a global socket object.
    global.sockets          =   {};
    global.fillData         =   {};
    
    global.lastUpdateCRN    =   Date.now();
    var timeOutTime =   {}
    
    // Grab the last update time.
    memServer.get(CRN_UPDATE_KEY,function(e,data){
        //Set the lastUpdate variable
        global.lastUpdateCRN    = 0;
        console.log(600-(parseInt(Date.now()/1000)-parseInt(data.substr(1))));
        //Set the timeout function to go off after 10min since last update on memcached side.
        setTimeout(app.timeOut,(600-(parseInt(Date.now()/1000)-parseInt(data.substr(1)))));
    });
};

app.timeOut =   function(){
    memServer.get(CRN_UPDATE_KEY,function(e,data){
        //GRAB ALL CRNS and store in fillData
        
        memServer.getMulti(CRN_ARRAY, function (err, data) {
            //Populate the global fillData object with crns and their corresponding data.
            for(var crn in data){
                global.fillData[crn.substr(CRN_PREFIX.length)]   =   data[crn];
            }
            app.pushSockets();
        });
    });
    //Do this again in 10 minutes
    setTimeout(app.timeOut,60000);
};

app.pushSockets =   function(){
    // Go through all the sockets
    for(var socketId in global.sockets){
        // Make an array for CRN data
        crnData =   [];
        global.sockets[socketId].crns.forEach(function(crn,index,array){
            //push all the necessary crn data to the array
            crnJSON.push(crn);
        });
        //Push that data to the socket
        global.sockets[socketId].socket.emit(courseData,crnJSON);
    }

};





module.exports  =   app;