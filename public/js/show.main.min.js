var TEACHER_RATING_AVERAGE=3.6679156419657004,STANDARD_DEVIATION=1.0229023978801683;localStorage.RAW_COURSE_DATA=JSON.stringify(RAW_COURSE_DATA);
CORE={raw_data:RAW_COURSE_DATA,scheduleOptions:{all:[],current:[]},courseData:{map:{},array:[]},main:{teacher:{ratings:{map:{}}},parse:{},search:{depther:{}},schedule:{}},helper:{time:{},hook:{}},sort:{functions:{type:"Starting Time",time:{mornings:null,noon:null,evenings:null,timeOfDay:"mornings"},blockAmount:null},type:""},view:{schedule:{},toolTip:{},customElements:{},controlPanel:{timeSort:{}},show:{}},socket:{seatMap:{}}};CORE.helper.hook=function(c){};
CORE.helper.time=function(c){return{getTime:function(b){var a=parseInt(b/60);b%=60;return 12<a?[a-12,":",b," pm"].join(""):[a,":",b," am"].join("")},getMinutes:function(b){b=b.split(":");return 60*parseInt(b[0])+1*parseInt(b[1])},inTime:function(b,a,e,c){return isNaN(b)||isNaN(e)?!1:e>=b&&e<a||c>b&&c<a||b>=e&&b<c||a>e&&a<c?!0:!1},sameDay:function(b,a){if(-1===b[0]||-1===a[0])return!1;for(var e=0;e<b.length;e++)if(-1<a.indexOf(b[e]))return!0;return!1}}}(CORE);
CORE.helper.color=function(c){return{changeTint:function(b,a){b=String(b).replace(/[^0-9a-f]/gi,"");6>b.length&&(b=b[0]+b[0]+b[1]+b[1]+b[2]+b[2]);a=a||0;var e="",c,d;for(d=0;3>d;d++)c=parseInt(b.substr(2*d,2),16),c=Math.round(Math.min(Math.max(0,c+c*a),255)).toString(16),e+=("00"+c).substr(c.length);return e},getTextColor:function(b){b=b.substr(1);var a=parseInt(b.substr(0,2),16),c=parseInt(b.substr(2,2),16);b=parseInt(b.substr(4,2),16);return 105>255-(.299*a+.587*c+.114*b)?"#222222":"#ffffff"},getBackgroundColor:function(b){return"#"+
this.changeTint(("000000"+(parseInt(parseInt(b,36).toExponential().slice(2,-5),10)&16777215).toString(16).toUpperCase()).slice(-6),.1)}}}(CORE);CORE.helper.element=function(c){return{changeStyle:function(b,a){for(var c in a)b.style[c]=a[c]},createDiv:function(b){var a=document.createElement("div"),c;for(c in b)a.setAttribute(c,b[c]);return a}}}(CORE);
CORE.main.parse=function(c){c.raw_data.forEach(function(a,b,g){a.instructor=a.instructor.slice(0,-1);c.main.teacher.ratings.map[a.instructor]=-.001;courseKey=[a.subject,a.code,"|",-1===a.section.indexOf("#")?"":"LAB"].join("");a.courseCode=a.subject+a.code;a.endTime=c.helper.time.getMinutes(a.endTime);a.startTime=c.helper.time.getMinutes(a.startTime);var d={startTime:a.startTime,endTime:a.endTime,day:a.days,instructor:a.instructor};d.day="-1"==d.day?[-1]:d.day.split("").map(Number);g=c.courseData.map[courseKey];
if(void 0!==g){b=0;var k=!1;for(b=g.sections.length;b--;)if(g.sections[b].crn===a.CRN){k=!0;break}k?g.sections[b].times.every(function(a){return JSON.stringify(a)!==JSON.stringify(d)})&&g.sections[b].times.push(d):g.sections.push({courseName:a.subject+a.code,lab:-1!==a.section.indexOf("#"),crn:a.CRN,courseId:a.id,section:a.section,campus:a.campus,times:[d],students:{enrolled:0,waitlisted:0,max:0}})}else c.courseData.map[courseKey]={courseName:a.subject+a.code,sections:[{courseName:a.subject+a.code,
lab:-1!==a.section.indexOf("#"),crn:a.CRN,courseId:a.id,section:a.section,campus:a.campus,times:[d],students:{enrolled:0,waitlisted:0,max:0}}]}});for(var b in c.courseData.map)c.courseData.array.push(c.courseData.map[b])}(CORE);
CORE.sort.functions=function(c){return{type:"Starting Time",time:{mornings:function(b,a){for(var c=0,g=0,d=0,k=0,f=b.length;f--;)for(var h=b[f].times.length;h--&&-1!=b[f].times[h].day[0];)c+=b[f].times[h].startTime*b[f].times[h].day.length,d+=b[f].times[h].day.length;for(f=a.length;f--;)for(h=a[f].times.length;h--&&-1!=a[f].times[h].day[0];)g+=a[f].times[h].startTime*a[f].times[h].day.length,k+=a[f].times[h].day.length;return c/d-g/k},noon:function(b,a){for(var c=0,g=0,d=0,k=0,f=b.length;f--;)for(var h=
b[f].times.length;h--&&-1!=b[f].times[h].day[0];)c+=Math.abs((b[f].times[h].startTime-b[f].times[h].endTime)/2-720)*b[f].times[h].day.length,d+=b[f].times[h].day.length;for(f=a.length;f--;)for(h=a[f].times.length;h--&&-1!=a[f].times[h].day[0];)g+=Math.abs((a[f].times[h].startTime-a[f].times[h].endTime)/2-720)*a[f].times[h].day.length,k+=a[f].times[h].day.length;return g/k-c/d},evenings:function(b,a){for(var c=0,g=0,d=0,k=0,f=b.length;f--;)for(var h=b[f].times.length;h--&&-1!=b[f].times[h].day[0];)c+=
b[f].times[h].startTime*b[f].times[h].day.length,d+=b[f].times[h].day.length;for(f=a.length;f--;)for(h=a[f].times.length;h--&&-1!=a[f].times[h].day[0];)g+=a[f].times[h].startTime*a[f].times[h].day.length,k+=a[f].times[h].day.length;return g/k-c/d},timeOfDay:"mornings"},teacherRating:function(b,a){for(var e=0,g=0,d=0,k=0,f=b.length;f--;)e+=c.main.teacher.ratings.map[b[f].times[0].instructor],d++;for(f=a.length;f--;)g+=c.main.teacher.ratings.map[a[f].times[0].instructor],k++;return g/k-e/d},availability:function(b,
a){for(var e=0,g=0,d=b.length;d--;)var k=c.socket.seatMap[b[d].crn],e=e+(1E5*(0<k.m-k.e)-100*k.w+(k.m-k.e));for(d=a.length;d--;)var f=c.socket.seatMap[a[d].crn],g=g+(1E5*(0<f.m-f.e)-100*f.w+(k.m-k.e));return g-e},blockAmount:function(c,a){return a.times.length-c.times.length}}}(CORE);
CORE.sort.functions.start=function(c){return function(){document.getElementById("main-loadingGear").style.display="block";document.getElementById("main-scheduleContainer").innerHTML="";setTimeout(function(){c.main.show.current=0;switch(c.sort.functions.type){case "Starting Time":var b=(new Date).getTime();c.scheduleOptions.current.sort(c.sort.functions.time[c.sort.functions.time.timeOfDay]);break;case "Teacher Rating":b=(new Date).getTime();c.scheduleOptions.current.sort(c.sort.functions.teacherRating);
break;case "Availability":b=(new Date).getTime(),c.scheduleOptions.current.sort(c.sort.functions.availability)}console.log("Sorting Took: "+(Date.now()-b)+"ms");document.getElementById("main-loadingGear").style.display="none";c.main.show.go(0)},10)}}(CORE);
CORE.filter=function(c){DBKey={ABBY:"Abbotsford",CHIL:"Chilliwack",HOPE:"Hope",MIS:"Mission",ONL:"Online",CLEAR:"Clearbrook"};return{campus:function(){var b=[],a=c.view.controlPanel.campusFilter.campusOn,e;for(e in a)a[e]||b.push(DBKey[e]);a=Date.now();c.scheduleOptions.current=c.scheduleOptions.all.filter(function(a){for(var c=a.length;c--;)if(-1<b.indexOf(a[c].campus))return!1;return!0});console.log("Filtering Took: "+(Date.now()-a)+"ms")}}}(CORE);
CORE.main.show=function(c){return{current:0,go:function(b){b=this.current||b;var a=10;b>=c.scheduleOptions.current.length-10&&(a=c.scheduleOptions.current.length-b);for(var e=b;e<b+a;e++){var g=c.view.schedule.generate(c.scheduleOptions.current[e]);document.getElementById("main-scheduleContainer").appendChild(g)}this.current+=10;c.socket.updateSeats();return b},init:function(){window.onscroll=function(b){currentScroll=document.documentElement.scrollTop?parseInt(document.documentElement.scrollTop):
parseInt(document.body.scrollTop);parseInt(currentScroll)>=400*c.main.show.current&&c.main.show.go()}}}}(CORE);
CORE.main.teacher.functions=function(c){return{generate:function(b,a){var e=b.getElementsByClassName("r-ratingContainer")[0],g=0,d=0;a.forEach(function(a,b,k){b=document.createElement("div");b.innerHTML+=['<div class="crn_',a.crn,'"style="float:left;border:1px solid #DDD;box-sizing:border-box;height:28px;margin-top:1px;padding-left:5px;padding-right:5px;line-height:28px;margin-right:10px;"><strong style="text-shadow:0 0px 1px #999" data-seatsCRN="',a.crn,'"></strong> seats left</div>','<strong style="color:'+
c.helper.color.getBackgroundColor(a.courseName)+'">',a.courseName,"</strong> ",a.section," ",a.times[0].instructor," <strong>",0<c.main.teacher.ratings.map[a.times[0].instructor]?c.main.teacher.ratings.map[a.times[0].instructor]:"","<strong><br>"].join("");e.appendChild(b);0<c.main.teacher.ratings.map[a.times[0].instructor]&&(g+=c.main.teacher.ratings.map[a.times[0].instructor],d++)});var k=document.createElement("div");k.className="r-averageRating";k.innerHTML=(g/d).toFixed(3);e.parentNode.insertBefore(k,
e)},fetch:function(b){var a=Object.keys(c.main.teacher.ratings.map);$.get({url:["/s/getTeacher?teachers=",JSON.stringify(a)].join(""),done:function(a){try{a.forEach(function(a,b,e){c.main.teacher.ratings.map[a.teacherName]=a.teacherRating}),b&&b()}catch(g){console.log(g)}}})},onFetched:function(){}}}(CORE);var counter=0;
CORE.main.search=function(c){return{depther:function(b,a){if(0>a)c.scheduleOptions.all.push(b);else{var e=c.courseData.array,g=e[a].sections.length;a:for(;g--;){for(var d=b.length;d--;){if(b[d].courseName===e[a].sections[g].courseName&&b[d].campus!==e[a].sections[g].campus&&"Online"!==b[d].campus)continue a;for(var k=b[d].times.length;k--;)for(var f=e[a].sections[g].times.length;f--;){var h=b[d].times[k],l=e[a].sections[g].times[f];if(c.helper.time.sameDay(h.day,l.day)&&c.helper.time.inTime(h.startTime,
h.endTime,l.startTime,l.endTime))continue a}}0==a?c.scheduleOptions.all.push(b.concat([e[a].sections[g]])):c.main.search.depther(b.concat([e[a].sections[g]]),a-1)}}},init:function(b){setTimeout(function(){var a=(new Date).getTime();c.courseData.array[c.courseData.array.length-1].sections.forEach(function(a,b,d){c.main.search.depther([a],c.courseData.array.length-2)});console.log("Scheduling Took: "+(Date.now()-a)+"ms");c.scheduleOptions.current=c.scheduleOptions.all;b&&b()},50)}}}(CORE);
function firstToUpperCase(c){return c.substr(0,1).toUpperCase()+c.substr(1)}
CORE.view.schedule=function(c){return{makeBlock:function(b,a,e){if(-1==e)return document.createElement("div");var g=c.helper.element.createDiv({"class":"s-timeBlock"});c.helper.element.changeStyle(g,{top:[(a.startTime-480)/2,"px"].join(""),left:[71*(e+1),"px"].join(""),height:[(a.endTime-a.startTime)/2,"px"].join(""),lineHeight:[(a.endTime-a.startTime-4)/2,"px"].join(""),color:c.helper.color.getTextColor(c.helper.color.getBackgroundColor(b.courseName)),backgroundColor:c.helper.color.getBackgroundColor(b.courseName)});
g.innerHTML=b.courseName;return g},generate:function(b){var a=document.getElementById("scheduleWrapTemplate").cloneNode(!0),e=[];a.id="";b.forEach(function(b,d,k){e.push(b.crn);b.times.forEach(function(e,d,k){e.day.forEach(function(k,l,m){k=c.view.schedule.makeBlock(b,e,k);k.setAttribute("data-timeIndex",d);c.view.toolTip.add(k,b);a.getElementsByClassName("s-timeBlockWrap")[0].appendChild(k)})})});a.getElementsByClassName("s-useMeButton")[0].onclick=function(){localStorage.currentSchedule=e.join(".");
document.location="/s/builder#"+e.join(".")};c.main.teacher.functions.generate(a,b);document.getElementById("main-scheduleContainer").appendChild(a);return a}}}(CORE);
CORE.view.controlPanel.timeSort=function(c){var b=document.getElementById("timeSort-wrap");(function(a){a.forEach(function(a,b,c){var k=document.getElementById("timeSort-upper");c=document.createElement("span");k.appendChild(c);c.innerHTML=a;c.className="timeSort-label";c.setAttribute("data-labelValue",a);a=c.offsetWidth;b+=1;c.style.marginLeft=20*(b-1)+10+50*(b-1)-a/2+"px";c.style.display="none"})})(["Mornings","Noon","Evenings"]);[].slice.call(document.getElementsByClassName("timeSort-ball")).forEach(function(a,
b,g){a.addEventListener("click",function(){if(a!==b&&!c.view.controlPanel.timeSort.disabled){var b=document.getElementById("timeSort-ball-active"),e=b&&b.getAttribute("data-value");b&&(b.id="",document.querySelectorAll('[data-labelValue="'+e+'"]')[0].style.display="none");b=a.getAttribute("data-value");a.id="timeSort-ball-active";document.querySelectorAll('[data-labelValue="'+b+'"]')[0].style.display="";c.sort.functions.time.timeOfDay=b.toLowerCase();c.sort.functions.time.type="Starting Time";c.sort.functions.start()}})});
return{disabled:!1,activate:function(a){var b=document.getElementById("timeSort-ball-active"),g=b&&b.getAttribute("data-value");b&&(b.id="",document.querySelectorAll('[data-labelValue="'+g+'"]')[0].style.display="none");b=a.getAttribute("data-value");a.id="timeSort-ball-active";document.querySelectorAll('[data-labelValue="'+b+'"]')[0].style.display="";c.sort.functions.time.timeOfDay=b.toLowerCase();c.sort.functions.time.type="Starting Time";c.sort.functions.start()},disable:function(){b.style.opacity=
"0.4";c.view.controlPanel.timeSort.disabled=!0},enable:function(){b.style.opacity="1";c.view.controlPanel.timeSort.disabled=!1;c.sort.functions.type="Starting Time"}}}(CORE);
CORE.view.customElements.checkBoxes=function(c){var b={onClick:function(a){"false"==a.target.getAttribute("checked")?(a.target.setAttribute("checked",!0),a.target.classList.add("customCheckbox-checked")):(a.target.setAttribute("checked",!1),a.target.classList.remove("customCheckbox-checked"));b.globalExt(a)},globalExt:function(a){},addExt:function(a,b){[].slice.call(document.querySelectorAll('[data-uniqID="'+a+'"]')).forEach(function(a,c,k){a.addEventListener("mousedown",function(a){a.shiftKey||b&&
b(a)})})}};[].slice.call(document.getElementsByClassName("customCheck")).forEach(function(a,e,g){e=a.getAttribute("data-keep");var d={checked:!1,"class":""};e&&e.split(" ").forEach(function(b,c,e){d[b]=a.getAttribute(b)});d["class"]+=" customCheckBox";e=c.helper.element.createDiv(d);e.addEventListener("mousedown",b.onClick);a.parentNode.replaceChild(e,a)});return b}(CORE);
CORE.view.controlPanel.campusFilter=function(c){[{name:"Abbotsford",uniq:"ABBY",check:null},{name:"Chilliwack",uniq:"CHIL",check:null},{name:"Hope",uniq:"HOPE",check:null},{name:"Mission",uniq:"MIS",check:null},{name:"Clearbrook",uniq:"CLEAR",check:null},{name:"Online",uniq:"ONL",check:null}].forEach(function(b,a,e){c.view.customElements.checkBoxes.addExt(b.uniq,function(a){"true"==a.target.getAttribute("checked")?c.view.controlPanel.campusFilter.campusOn[b.uniq]=!0:c.view.controlPanel.campusFilter.campusOn[b.uniq]=
!1;c.filter.campus(b.uniq);c.sort.functions.start()})});return{campusOn:{ABBY:!0,CHIL:!0,HOPE:!0,MIS:!0,ONL:!0,CLEAR:!0}}}(CORE);
CORE.view.controlPanel.sortDrop=function(c){var b=document.getElementById("sort-dropDownList"),a=document.getElementById("sort-dropDownButton");document.addEventListener("click",function(a){if(c.view.controlPanel.sortDrop.down&&!a.target.classList.contains("sort-dropDownItem"))c.view.controlPanel.sortDrop.move.up();else if(a.target.classList.contains("sort-dropDownItem"))switch(document.querySelectorAll('[data-value="'+c.view.controlPanel.sortDrop.currentValue+'"]')[0].style.display="block",a.target.style.display=
"none",c.view.controlPanel.sortDrop.move.up(),c.view.controlPanel.sortDrop.setWords(a.target.getAttribute("data-value")),a.target.getAttribute("data-value")){case "Teacher Rating":c.sort.functions.type="Teacher Rating";c.view.controlPanel.timeSort.disable();c.sort.functions.start();break;case "Starting Time":c.sort.functions.type="Starting Time";c.view.controlPanel.timeSort.enable();c.sort.functions.start();break;case "Availability":c.sort.functions.type="Availability",c.view.controlPanel.timeSort.disable(),
c.sort.functions.start()}});a.addEventListener("click",function(e){e.stopPropagation();c.view.controlPanel.sortDrop.down?(a.style.backgroundImage="",c.view.controlPanel.sortDrop.down=!1,Velocity(b,"slideUp",100)):(a.style.backgroundImage="url(/images/upArrow.png)",c.view.controlPanel.sortDrop.down=!0,Velocity(b,"slideDown",100))});return{setWords:function(b){a.innerHTML='Sort By <label style="font-weight:100">|</label><label style="font-weight:300;"> '+b+"</label>";c.view.controlPanel.sortDrop.currentValue=
b},down:!1,currentValue:"Starting Time",move:{down:function(){a.style.backgroundImage="url(../images/upArrow.png)";c.view.controlPanel.sortDrop.down=!0;Velocity(b,"slideDown",100)},up:function(){a.style.backgroundImage="";c.view.controlPanel.sortDrop.down=!1;Velocity(b,"slideUp",100)}}}}(CORE);
CORE.view.toolTip=function(c){return{setUp:function(b){var a=document.getElementById("t-toolTipWrap");a.style.display="block";var c=document.body.getBoundingClientRect();b=b.target.getBoundingClientRect();var g=b.left-c.left;a.style.top=b.top-c.top+80+b.height+"px";a.style.left=g-150+"px";document.getElementById("t-toolTipTimes").innerHTML=""},onHover:function(b,a){var e=b.target.getAttribute("data-timeIndex");c.view.toolTip.setUp(b);var g={0:"Monday",1:"Tuesday",2:"Wednesday",3:"Thursday",4:"Friday",
5:"Saturday",6:"Sunday"},d=document.getElementById("t-toolTipCourseName");d.innerHTML=[a.courseName,a.lab?" - LAB":"",'<label style="float:right;">',a.section,"</label>"].join("");d.style.color=c.helper.color.getBackgroundColor(a.courseName);var k=document.getElementById("t-toolTipCRN"),f=document.getElementById("t-toolTipInstructor"),d=document.getElementById("t-toolTipRating"),h=document.getElementById("t-toolTipImage");k.innerHTML="CRN: "+a.crn;f.innerHTML=a.times[e].instructor;0<c.main.teacher.ratings.map[a.times[e].instructor]?
(h.style.background="",k=c.main.teacher.ratings.map[a.times[e].instructor],d.innerHTML=k.toFixed(3),k>=TEACHER_RATING_AVERAGE+STANDARD_DEVIATION/2?h.style.backgroundColor="#2ecc71":k<TEACHER_RATING_AVERAGE+STANDARD_DEVIATION/2&&k>=TEACHER_RATING_AVERAGE-STANDARD_DEVIATION/2?(h.style.backgroundPosition="-100px 0px",h.style.backgroundColor="#f1c40f"):TEACHER_RATING_AVERAGE-STANDARD_DEVIATION/2&&(h.style.backgroundPosition="-200px 0px",h.style.backgroundColor="#e74c3c")):(d.innerHTML="N/A",h.style.background=
"#DDD");for(d=0;d<a.times.length;d++)for(h=0;h<a.times[d].day.length&&-1!==a.times[e].day[h];h++)document.getElementById("t-toolTipTimes").innerHTML+=["<strong>",g[a.times[d].day[h]],": </strong>",c.helper.time.getTime(a.times[d].startTime)," - ",c.helper.time.getTime(a.times[d].endTime),"<br>"].join("")},onMove:function(b,a){document.getElementById("t-toolTipWrap").style.display="none"},add:function(b,a){var c=this;b.addEventListener("mouseover",function(b){c.onHover(b,a)});b.addEventListener("mouseout",
function(b){c.onMove(b,a)})}}}(CORE);
CORE.socket=function(c){var b=io("http://localhost:8080");b.on("crnData",function(a){a.forEach(function(a,b,d){c.socket.seatMap[a[0]]=JSON.parse(a[1]);[].forEach.call(document.getElementsByClassName("crn_"+a[0]),function(b,d,g){d=c.socket.seatMap[a[0]].m-c.socket.seatMap[a[0]].e;b.innerHTML=0>=d?c.socket.seatMap[a[0]].w+" waitlisted":d+" spot"+(1<d?"s":"")})})});return{seatMap:{},socket:b,updateSeats:function(){for(var a in c.socket.seatMap){var b=c.socket.seatMap[a];[].forEach.call(document.getElementsByClassName("crn_"+
a),function(a,c,k){c=b.m-b.e;a.innerHTML=0>=c?b.w+" waitlisted":c+" spot"+(1<c?"s":"")})}}}}(CORE);(function(){CORE.main.search.init(function(){CORE.main.teacher.functions.fetch(function(){CORE.sort.functions.type="Starting Time";CORE.view.controlPanel.timeSort.activate(document.getElementsByClassName("timeSort-ball")[0])});CORE.main.show.init()})})();
